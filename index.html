<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bet Buzz — Week 1 (Live)</title>
  <style>
    :root {
      --bg:#0b1020; --card:#121931; --text:#e8eefc; --muted:#a8b3cf;
      --accent:#7cc4ff; --border:#233058; --elev:0 10px 30px rgba(0,0,0,.2);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
    header{padding:20px;display:flex;gap:14px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .tag{background:#1a2447;color:var(--muted);padding:6px 10px;border-radius:999px;border:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px;display:grid;grid-template-columns:340px 1fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--elev)}
    .pad{padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,button{background:#0f1730;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    .kpi{padding:12px;border:1px dashed var(--border);border-radius:12px;background:#0e162c}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:18px;font-weight:700;margin-top:4px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1730;display:inline-block}
    .good{background:rgba(141,227,141,.12);border-color:#234a23}
    .bad{background:rgba(255,154,162,.12);border-color:#4a2323}
    .neutral{background:rgba(124,196,255,.12);border-color:#234a4a}
    .oddsRow{display:grid;grid-template-columns:140px repeat(3,1fr);gap:10px;align-items:center;border-top:1px solid var(--border);padding:10px 0}
    .oddsRow:first-child{border-top:0}
    .muted{color:var(--muted)}
    .big{font-size:28px;font-weight:700}
    .list{display:flex;flex-direction:column;gap:12px;margin-top:8px}
    .quote{padding:12px;border:1px solid var(--border);border-radius:12px;background:#0f1730}
    .src{font-size:12px;color:var(--muted)}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0f1730;color:var(--muted)}
    .foot{padding:14px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    a{color:var(--accent);text-decoration:none}
    @media(max-width:980px){.wrap{grid-template-columns:1fr}}
    .tab.active{outline:2px solid #365ca0}
  </style>
</head>
<body>
<header>
  <h1>Bet Buzz</h1>
  <span class="tag">Week 1 • NCAA</span>
  <span class="tag" id="modeTag">Live</span>
</header>

<div class="wrap">
  <!-- Left: picker -->
  <div class="card pad">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div>
        <div class="muted" style="font-size:12px">Select a game</div>
        <select id="gameSelect"></select>
      </div>
      <div>
        <div class="muted" style="font-size:12px">Market</div>
        <div class="row">
          <button class="tab active" data-market="spread">Spread</button>
          <button class="tab" data-market="moneyline">Moneyline</button>
          <button class="tab" data-market="total">Total</button>
        </div>
      </div>
    </div>
    <div class="kpi">
      <div class="label">Consensus Edge (model)</div>
      <div class="val" id="edgeText">—</div>
      <div class="muted" id="edgeNote" style="font-size:12px;margin-top:6px">Compare to your model once added.</div>
    </div>
    <div class="kpi" style="margin-top:12px">
      <div class="label">Public % (tickets / handle)</div>
      <div class="val" id="publicPct">50% tix / 50% $ on HOME</div>
      <div class="muted" style="font-size:12px;margin-top:6px">Mocked until you add a splits provider.</div>
    </div>
    <div class="kpi" style="margin-top:12px">
      <div class="label">Sentiment (last 24h)</div>
      <div class="val" id="sentiment">—</div>
      <div class="muted" style="font-size:12px;margin-top:6px">Weighted by source credibility.</div>
    </div>
  </div>

  <!-- Right: details -->
  <div class="card">
    <div class="pad" id="matchHeader"></div>

    <div class="pad">
      <div class="grid">
        <div class="kpi">
          <div class="label">Best Line (you can get)</div>
          <div class="val" id="bestLine">—</div>
          <div class="muted" style="font-size:12px;margin-top:6px" id="bestLineBook">—</div>
        </div>
        <div class="kpi">
          <div class="label">Implied Probability</div>
          <div class="val" id="implied">—</div>
          <div class="muted" style="font-size:12px;margin-top:6px">For the selected side/market.</div>
        </div>
        <div class="kpi">
          <div class="label">Quick EV (vs. model)</div>
          <div class="val" id="quickEV">—</div>
          <div class="muted" style="font-size:12px;margin-top:6px">Model win prob – implied prob.</div>
        </div>
      </div>
    </div>

    <div class="pad">
      <div class="muted" style="margin-bottom:8px">Lines across books</div>
      <div id="oddsTable"></div>
    </div>

    <div class="pad">
      <div class="row" style="justify-content:space-between">
        <div class="muted">What people are saying</div>
        <span class="badge" id="snippetCount">—</span>
      </div>
      <div class="list" id="snippets"></div>
    </div>

    <div class="foot">
      <div class="muted">Prototype • Live odds & chatter via API • Fallback to mocks</div>
      <div class="row">
        <button id="flipSide">Flip Side</button>
        <button id="refresh">Refresh</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = 'https://bet-buzz-api.onrender.com'; // your Render API

/* ================= UTILS ================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function moneylineToImplied(ml){ if(ml===0) return 0.5; return ml>0 ? 100/(ml+100) : -ml/(-ml+100); }
function formatPct(x){ return (x*100).toFixed(1)+'%'; }
function fmtPrice(p){ return p>0? '+'+p : String(p); }
function averageSpreadNumber(lines){ return lines.length ? lines.map(l=>+l.home).reduce((a,b)=>a+b,0)/lines.length : 0; }
function quickEV(modelProb, impliedProb){ const ev=modelProb-impliedProb; return (ev>=0?'+':'')+(ev*100).toFixed(1)+' pts'; }
function signClass(v){ return v>0.05?'good':v<-0.05?'bad':'neutral'; }
function bestLineML(lines, side){
  if(!lines||!lines.length) return null;
  if(side==='home'){
    return lines.reduce((best,l)=>!best?l:(((l.home>0 && best.home<0)||(l.home>best.home && l.home<=0)||(l.home>best.home && best.home>0))?l:best),null);
  } else {
    return lines.reduce((best,l)=>!best?l:(l.away>best.away?l:best),null);
  }
}

/* ================= STATE ================= */
let state = { market:'spread', gameId:null, side:null };
let REMOTE_GAMES = [];                // built from /api/odds-all
let CURRENT_ODDS = null;              // odds object for selected game
let ALL_EVENTS = [];                  // raw events from /api/odds-all
let ODDS_BY_ID = Object.create(null); // { eventId: odds }

/* ================= MOCKS (fallback only) ================= */
const MOCK_GAMES = [
  { id:'osu-tex', kickoff:'2025-08-30T16:00:00Z', home:'Ohio State', away:'Texas', home_rank:3, away_rank:1, venue:'Ohio Stadium' }
];
const MOCK_ODDS = {
  'osu-tex': {
    spread:{ side:'home', lines:[ {book:'DRAFTKINGS',home:-2.5,away:+2.5,price_home:-110,price_away:-110} ] },
    moneyline:{ side:'home', lines:[ {book:'DRAFTKINGS',home:-126,away:+105} ] },
    total:{ target:47.5, lines:[ {book:'DRAFTKINGS',over:47.5,under:47.5,price_over:-110,price_under:-110} ] },
    public:{ spread:{tickets_home:50,handle_home:50}, ml:{tickets_home:50,handle_home:50}, total:{tickets_over:50,handle_over:50} },
    sentiment:{ score:0, snippets:[] }
  }
};

/* ================= API CALLS ================= */
// Pull ALL events with odds in one call
async function fetchAllOddsEvents(){
  const r = await fetch(`${API_BASE}/api/odds-all`);
  if(!r.ok) throw new Error('odds-all failed');
  const { events } = await r.json();
  return events;
}

// Optional: chatter per selection
async function fetchChatterFor(game){
  const q = `${game.away} ${game.home} spread odds`;
  const r = await fetch(`${API_BASE}/api/chatter?q=${encodeURIComponent(q)}`);
  if(!r.ok) throw new Error('chatter failed');
  return r.json();
}

/* ================= RENDER HELPERS ================= */
function renderAll(){ renderHeader(); renderOddsTable(); renderSnippets(); }

function getCurrentGame(){
  const list = REMOTE_GAMES.length ? REMOTE_GAMES : MOCK_GAMES;
  return list.find(x=>x.id===state.gameId) || list[0];
}

function renderGameOptions(){
  const sel = $('#gameSelect');
  const list = REMOTE_GAMES.length ? REMOTE_GAMES : MOCK_GAMES;
  sel.innerHTML = list.map(g => `<option value="${g.id}">${g.away} @ ${g.home}</option>`).join('');
  if(!state.gameId && list[0]) state.gameId = list[0].id;
  sel.value = state.gameId;
}

function rowHeader(cols){ return `<div class="oddsRow muted">${cols.map(c=>`<div>${c}</div>`).join('')}</div>`; }
function oddsRow(book,c1,c2,c3){ return `<div class="oddsRow"><div><b>${book}</b></div><div>${c1}</div><div>${c2}</div><div class="muted">${c3}</div></div>`; }

function renderHeader(){
  const g = getCurrentGame();
  const odds = CURRENT_ODDS || MOCK_ODDS[g.id] || {spread:{lines:[]},moneyline:{lines:[]},total:{target:null,lines:[]},public:{},sentiment:{score:0,snippets:[]}};
  const m = state.market;
  const side = state.side || (m==='total' ? 'over' : (odds[m]?.side || 'home'));

  const lineAvg = m==='spread' ? averageSpreadNumber(odds.spread.lines||[]).toFixed(1)
                : m==='moneyline' ? '—'
                : (odds.total.target!=null ? Number(odds.total.target).toFixed(1) : '—');

  $('#matchHeader').innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div class="team">
        <div class="muted">${new Date(g.kickoff || Date.now()).toLocaleString()}</div>
        <div class="big">${g.away} @ ${g.home}</div>
        <div class="muted">${g.venue || ''}</div>
      </div>
      <div class="row">
        <span class="pill">Market: <b style="margin-left:6px">${m}</b></span>
        <span class="pill">Avg Line: <b style="margin-left:6px">${lineAvg}</b></span>
        <span class="pill">Side: <b style="margin-left:6px" id="sideLabel">${String(side).toUpperCase()}</b></span>
      </div>
    </div>`;

  // Edge (simple placeholders)
  if(m==='moneyline' && (odds.moneyline?.lines?.length)){
    const best = bestLineML(odds.moneyline.lines, side);
    const price = side==='home'? best.home : best.away;
    const modelProbHome = 0.55; // placeholder
    const modelProb = side==='home'? modelProbHome : (1-modelProbHome);
    const implied = moneylineToImplied(price);
    $('#edgeText').textContent = quickEV(modelProb, implied);
    $('#edgeNote').textContent = `Model win ${formatPct(modelProb)} vs implied ${formatPct(implied)} @ ${best.book} ${fmtPrice(price)}.`;
  } else if(m==='spread'){
    const avg = averageSpreadNumber(odds.spread.lines||[]);
    $('#edgeText').textContent = (avg>=0?'+':'')+avg.toFixed(1)+' pts (market avg)';
    $('#edgeNote').textContent = 'Compare to your model once added.';
  } else {
    const tgt = odds.total?.target;
    $('#edgeText').textContent = (tgt!=null? tgt.toFixed(1) : '—');
    $('#edgeNote').textContent = 'Consensus total';
  }

  // KPIs
  if(m==='moneyline' && odds.moneyline?.lines?.length){
    const best = bestLineML(odds.moneyline.lines, side);
    const price = side==='home'? best.home : best.away;
    $('#bestLine').textContent = fmtPrice(price);
    $('#bestLineBook').textContent = `${best.book} • Best ${side.toUpperCase()} ML`;
    const imp = moneylineToImplied(price);
    $('#implied').textContent = formatPct(imp);
    const pHome = 0.55; const modelProb = side==='home'? pHome : (1-pHome);
    $('#quickEV').textContent = quickEV(modelProb, imp);
  } else if(m==='spread'){
    const avg = averageSpreadNumber(odds.spread.lines||[]);
    $('#bestLine').textContent = (avg>=0?'HOME ':'HOME ') + avg.toFixed(1);
    $('#bestLineBook').textContent = 'Avg across books';
    $('#implied').textContent = '—'; $('#quickEV').textContent = '—';
  } else {
    const tgt = odds.total?.target;
    $('#bestLine').textContent = (tgt!=null? tgt.toFixed(1):'—');
    $('#bestLineBook').textContent = 'Consensus total';
    $('#implied').textContent = '—'; $('#quickEV').textContent = '—';
  }
}

function renderOddsTable(){
  const g = getCurrentGame();
  const odds = CURRENT_ODDS || MOCK_ODDS[g.id] || {spread:{lines:[]},moneyline:{lines:[]},total:{lines:[]}};
  const m = state.market;
  const rows = [];
  if(m==='spread'){
    rows.push(rowHeader(['Book','Home','Away','Note']));
    (odds.spread.lines||[]).forEach(l=>{
      rows.push(oddsRow(l.book, `${l.home>0?'+':''}${l.home} (${fmtPrice(l.price_home)})`,
                               `${l.away>0?'+':''}${l.away} (${fmtPrice(l.price_away)})`, '—'));
    });
  } else if(m==='moneyline'){
    rows.push(rowHeader(['Book','Home ML','Away ML','Implied (sel)']));
    const sideSel = state.side || odds.moneyline.side || 'home';
    (odds.moneyline.lines||[]).forEach(l=>{
      const price = sideSel==='home'? l.home : l.away;
      rows.push(oddsRow(l.book, fmtPrice(l.home), fmtPrice(l.away), formatPct(moneylineToImplied(price))));
    });
  } else {
    rows.push(rowHeader(['Book','Over','Under','Note']));
    (odds.total.lines||[]).forEach(l=>{
      rows.push(oddsRow(l.book, `${l.over} (${fmtPrice(l.price_over)})`,
                               `${l.under} (${fmtPrice(l.price_under)})`, '—'));
    });
  }
  $('#oddsTable').innerHTML = rows.join('');
}

function renderSnippets(){
  const g = getCurrentGame();
  const odds = CURRENT_ODDS || MOCK_ODDS[g.id] || { sentiment:{score:0,snippets:[]} };
  const s = odds.sentiment || {score:0,snippets:[]};
  $('#sentiment').innerHTML = `<span class="pill ${signClass(s.score)}">Score ${(s.score>=0?'+':'') + (s.score||0).toFixed(2)}</span>`;
  $('#snippetCount').textContent = `${(s.snippets||[]).length} notes`;
  $('#snippets').innerHTML = (s.snippets||[]).map(q=>`
    <div class="quote">
      <div>${q.text}</div>
      <div class="row" style="margin-top:6px;justify-content:space-between">
        <span class="src">${q.src||''}</span>
        <span class="badge ${signClass(q.score||0)}">${(q.score>=0?'+':'') + (q.score||0).toFixed(2)}</span>
      </div>
    </div>`).join('') || '<div class="muted">No recent chatter found.</div>';
}

/* ================= LIVE FLOW ================= */
async function initLive(){
  // show mock immediately (so UI is never empty)
  if(!state.gameId) state.gameId = (MOCK_GAMES[0]?.id);
  renderGameOptions();
  CURRENT_ODDS = MOCK_ODDS[state.gameId] || null;
  renderAll();

  // try live: load ALL events with odds
  try{
    ALL_EVENTS = await fetchAllOddsEvents();
    if(ALL_EVENTS && ALL_EVENTS.length){
      ODDS_BY_ID = Object.fromEntries(ALL_EVENTS.map(ev => [ev.id, ev.odds]));
      REMOTE_GAMES = ALL_EVENTS.map(ev => ({
        id: ev.id, kickoff: ev.commence_time, home: ev.home, away: ev.away, venue: ''
      }));

      state.gameId = REMOTE_GAMES[0].id;
      CURRENT_ODDS = ODDS_BY_ID[state.gameId] || null;
      $('#modeTag').textContent = 'Live';
      renderGameOptions();
      renderAll();
      return;
    }
  } catch(e){
    console.warn('odds-all failed; using mocks', e);
    $('#modeTag').textContent = 'Mock';
  }
}

/* ================= EVENTS ================= */
function wire(){
  // game selection -> swap odds from preloaded map + fetch chatter
  $('#gameSelect').addEventListener('change', async (e)=>{
    state.gameId = e.target.value;
    state.side = null;
    CURRENT_ODDS = ODDS_BY_ID[state.gameId] || null;
    renderAll();

    // optional chatter for this matchup
    try{
      const g = getCurrentGame();
      const ch = await fetchChatterFor(g).catch(()=>({score:0,snippets:[]}));
      if(CURRENT_ODDS){
        CURRENT_ODDS.sentiment = { score: ch.score||0, snippets: ch.snippets||[] };
        renderSnippets();
      }
    }catch(_e){}
  });

  // tabs
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      state.market = btn.dataset.market;
      state.side = null;
      renderAll();
    });
  });

  // side flip
  $('#flipSide').addEventListener('click', ()=>{
    if(state.market==='total') return;
    const cur = state.side || 'home';
    state.side = (cur==='home' ? 'away' : 'home');
    $('#sideLabel').textContent = state.side.toUpperCase();
    renderHeader(); renderOddsTable();
  });

  // refresh (re-pull all events)
  $('#refresh').addEventListener('click', async ()=>{
    try{
      ALL_EVENTS = await fetchAllOddsEvents();
      ODDS_BY_ID = Object.fromEntries(ALL_EVENTS.map(ev => [ev.id, ev.odds]));
      // keep current selection if still present
      if(!ODDS_BY_ID[state.gameId] && ALL_EVENTS[0]){
        state.gameId = ALL_EVENTS[0].id;
      }
      CURRENT_ODDS = ODDS_BY_ID[state.gameId] || null;
      renderGameOptions();
      renderAll();
    }catch(e){ console.warn('refresh failed', e); }
  });
}

/* ================= BOOT ================= */
(function boot(){ wire(); initLive(); })();
</script>
</body>
</html>




